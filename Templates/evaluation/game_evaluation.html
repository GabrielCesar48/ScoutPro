{% extends 'base.html' %}

{% block title %}Avalia√ß√£o - {{ game.title }} - ScoutPro{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
    }
    
    .evaluation-header {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .game-timer {
        background: linear-gradient(45deg, #17a2b8, #138496);
        color: white;
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .timer-display {
        font-size: 2rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }
    
    .player-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border-radius: 10px;
        margin-bottom: 0.5rem;
    }
    
    .player-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .player-card.active {
        border: 2px solid #28a745;
        background-color: #f8f9fa;
    }
    
    .criteria-btn {
        margin: 2px;
        min-height: 80px;
        font-size: 1.1rem;
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    /* Efeito de clique incr√≠vel - IGUAL AO ORIGINAL */
    .criteria-btn.clicked {
        transform: scale(0.95);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
        background: linear-gradient(45deg, #28a745, #20c997) !important;
        color: white !important;
        border-color: #28a745 !important;
    }
    
    .criteria-btn.clicked.special {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
        background: linear-gradient(45deg, #ffc107, #ffca2c) !important;
        color: #000 !important;
    }
    
    .criteria-btn.clicked.negative {
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
        background: linear-gradient(45deg, #dc3545, #e74c3c) !important;
        color: white !important;
    }
    
    /* Anima√ß√£o de pulso */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .criteria-btn.pulse {
        animation: pulse 0.3s ease-in-out;
    }
    
    /* Efeito de confetti */
    @keyframes confetti {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
    }
    
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #ffc107;
        animation: confetti 0.6s ease-out;
        pointer-events: none;
    }
    
    .category-header {
        background: linear-gradient(45deg, #28a745, #1e7e34);
        color: white;
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
    }
    
    .category-header.negative {
        background: linear-gradient(45deg, #dc3545, #c82333);
    }
    
    .category-header.special {
        background: linear-gradient(45deg, #ffc107, #e0a800);
        color: #000;
    }
    
    .playing-time {
        font-size: 0.8rem;
        color: #28a745;
        font-weight: bold;
    }
    
    .player-stats {
        font-size: 0.8rem;
        background: rgba(0,123,255,0.1);
        border-radius: 5px;
        padding: 5px;
        margin-top: 5px;
    }
    
    /* Modal de resultados com scroll */
    .results-modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .save-indicator {
        position: fixed;
        top: 90px;
        right: 20px;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .substitution-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
    }
    
    @media (max-width: 768px) {
        .evaluation-header {
            padding: 1rem;
        }
        
        .timer-display {
            font-size: 1.5rem;
        }
        
        .criteria-btn {
            min-height: 60px;
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Save Indicator -->
<div id="saveIndicator" class="save-indicator">
    <i class="fas fa-save"></i> Dados salvos localmente
</div>

<!-- Evaluation Header -->
<div class="evaluation-header fade-in">
    <div class="row align-items-center">
        <div class="col-6">
            <h4 class="mb-1">{{ game.title }}</h4>
            <small>Avalia√ß√£o em Tempo Real</small>
        </div>
        <div class="col-6 text-end">
            <div class="btn-group btn-group-sm">
                <a href="{% url 'core:game_detail' game.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <button class="btn btn-warning btn-sm" onclick="viewResults()">
                    <i class="fas fa-chart-bar"></i> Resultados
                </button>
                <button class="btn btn-danger btn-sm" onclick="finishAndSaveGame()">
                    <i class="fas fa-save"></i> Finalizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Timer do Jogo -->
<div class="game-timer fade-in">
    <div class="row align-items-center">
        <div class="col-3">
            <button id="playPauseBtn" class="btn btn-light btn-lg">
                <i class="fas fa-play"></i>
            </button>
        </div>
        <div class="col-6 text-center">
            <div class="timer-display" id="gameTimer">00:00</div>
            <div><small id="gameStatus">Parado</small></div>
        </div>
        <div class="col-3 text-end">
            <button id="resetTimer" class="btn btn-secondary btn-sm mb-1" title="Reiniciar Cron√¥metro">
                <i class="fas fa-redo"></i>
            </button><br>
            <button id="makeSubstitution" class="btn btn-warning btn-sm" title="Substitui√ß√£o">
                <i class="fas fa-exchange-alt"></i>
            </button>
        </div>
    </div>
</div>

<!-- Painel de Substitui√ß√µes -->
<div class="substitution-panel fade-in">
    <div class="row align-items-center">
        <div class="col-8">
            <h6><i class="fas fa-exchange-alt"></i> Substitui√ß√µes</h6>
        </div>
        <div class="col-4 text-end">
            <button id="makeSubstitutionBtn" class="btn btn-warning btn-sm">
                <i class="fas fa-people-arrows"></i> Substituir
            </button>
        </div>
    </div>
</div>

<!-- Jogadores em Campo -->
<div class="row mb-4 fade-in">
    <div class="col-12">
        <h5><i class="fas fa-running text-success"></i> Jogadores em Campo</h5>
        <div class="row" id="playingPlayersRow">
            {% for player in playing_players %}
            <div class="col-6 col-md-4 mb-2">
                <button class="btn btn-outline-primary w-100 player-select-btn" 
                        data-player-id="{{ player.player.id }}"
                        data-player-name="{{ player.player.user.full_name|default:player.player.user.username }}"
                        data-player-type="{{ player.player.position }}">
                    <div><strong>{{ player.player.user.full_name|default:player.player.user.username }}</strong></div>
                    <div><small class="text-muted">{{ player.player.get_position_display }}</small></div>
                    <div class="playing-time">‚è±Ô∏è 00:00</div>
                    <div class="player-stats">
                        <span class="text-success">0</span> |
                        <span class="text-warning">‚òÖ0</span> |
                        <span class="text-danger">0</span>
                    </div>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Crit√©rios de Avalia√ß√£o - LAYOUT ORIGINAL -->
<div id="criteriaSection" style="display: none;" class="fade-in">
    <div class="row">
        <div class="col-12">
            <h5 class="text-center mb-3">
                Avaliar: <span id="selectedPlayerName" class="text-primary"></span>
                <span id="playerPosition" class="badge bg-secondary"></span>
            </h5>
        </div>
    </div>

    <!-- Crit√©rios para Jogadores de Linha -->
    <div id="fieldPlayerCriteria" style="display: none;">
        <div class="category-header">
            <h6><i class="fas fa-thumbs-up"></i> A√á√ÉO BOA (+1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success criteria-btn w-100 mb-2" 
                        data-criteria="acao_boa" 
                        data-category="positivo" 
                        data-points="1" 
                        style="min-height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-check-circle fa-2x"></i><br>
                    <strong>A√á√ÉO BOA</strong><br>
                    <small>Jogada ofensiva, passe decisivo, recupera√ß√£o importante</small>
                </button>
            </div>
        </div>

        <div class="category-header special">
            <h6><i class="fas fa-star"></i> IMPACTO NO JOGO (+2)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="gol" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-futbol fa-2x"></i><br>
                    <strong>GOL!</strong>
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="assistencia" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-hands-helping fa-2x"></i><br>
                    <strong>ASSIST√äNCIA</strong>
                </button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="jogada_genial" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-brain fa-2x"></i><br>
                    <strong>JOGADA GENIAL</strong><br>
                    <small>Drible espetacular, passe imposs√≠vel, decis√£o brilhante</small>
                </button>
            </div>
        </div>

        <div class="category-header negative">
            <h6><i class="fas fa-thumbs-down"></i> ERRO (-1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-danger criteria-btn w-100 mb-2" 
                        data-criteria="erro" 
                        data-category="negativo" 
                        data-points="-1" 
                        style="min-height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-times-circle fa-2x"></i><br>
                    <strong>ERRO</strong><br>
                    <small>Perda de bola perigosa, falta boba, chance perdida</small>
                </button>
            </div>
        </div>
    </div>

    <!-- Crit√©rios Espec√≠ficos para Goleiros -->
    <div id="goalkeeperCriteria" style="display: none;">
        <div class="category-header">
            <h6><i class="fas fa-shield-alt"></i> DEFESA BOA (+1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success criteria-btn w-100 mb-2" 
                        data-criteria="defesa_boa" 
                        data-category="positivo" 
                        data-points="1" 
                        style="min-height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-hand-paper fa-2x"></i><br>
                    <strong>DEFESA BOA</strong><br>
                    <small>Salvou o chute, sa√≠da no tempo certo, reposi√ß√£o r√°pida</small>
                </button>
            </div>
        </div>

        <div class="category-header special">
            <h6><i class="fas fa-star"></i> DEFESA SALVADORA (+2)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="defesa_salvadora" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-medal fa-2x"></i><br>
                    <strong>DEFESA SALVADORA</strong><br>
                    <small>Defesa espetacular, salvou gol certo</small>
                </button>
            </div>
        </div>

        <div class="category-header negative">
            <h6><i class="fas fa-exclamation-triangle"></i> FALHA (-1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-danger criteria-btn w-100 mb-2" 
                        data-criteria="falha_goleiro" 
                        data-category="negativo" 
                        data-points="-1" 
                        style="min-height: 80px; font-size: 1.2rem;">
                    <i class="fas fa-times-circle fa-2x"></i><br>
                    <strong>FALHA</strong><br>
                    <small>Sa√≠da errada, passe errado, gol por falha</small>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Substitui√ß√£o - SEM RECARREGAR P√ÅGINA -->
<div class="modal fade" id="substitutionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt"></i> Fazer Substitui√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Sai de Campo:</h6>
                        <div id="playersToSubOut">
                            <!-- Ser√° preenchido via JavaScript -->
                        </div>
                    </div>
                    <div class="col-6">
                        <h6>Entra no Jogo:</h6>
                        <div id="playersToSubIn">
                            <!-- Ser√° preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmSubstitution" disabled>
                    <i class="fas fa-check"></i> Confirmar Substitui√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultados com SCROLL CORRIGIDO -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trophy text-warning"></i>
                    Resultados do Jogo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body results-modal-body">
                <div id="resultsContent">
                    <!-- Resultados ser√£o inseridos aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="exportGameData()">
                    <i class="fas fa-download"></i> Exportar Dados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// SISTEMA H√çBRIDO: JavaScript Local + Persist√™ncia Django
// Baseado no sistema original que funcionava perfeitamente

// Estado da aplica√ß√£o - IGUAL AO ORIGINAL
let selectedPlayers = [];
let playingPlayers = [];
let benchPlayers = [];
let currentPlayer = null;
let evaluationData = {};
let playerTimes = {};
let gameTimer = {
    startTime: null,
    elapsed: 0,
    isRunning: false,
    interval: null
};
let substitutionData = [];
let selectedPlayerOut = null;
let selectedPlayerIn = null;

// Dados do jogo Django
const GAME_ID = {{ game.id }};
const GAME_TITLE = "{{ game.title }}";

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    loadGameData();
    setupEventListeners();
    renderPlayingPlayers();
    updateTimerDisplay();
    
    // Auto-save local a cada 10 segundos
    setInterval(function() {
        if (gameTimer.isRunning) {
            saveDataLocally();
        }
    }, 10000);
    
    // Salvar antes de sair da p√°gina
    window.addEventListener('beforeunload', function(e) {
        saveDataLocally();
        if (gameTimer.isRunning && Object.keys(evaluationData).length > 0) {
            e.preventDefault();
            e.returnValue = 'H√° avalia√ß√µes n√£o salvas. Deseja realmente sair?';
        }
    });
    
    console.log('üöÄ Sistema carregado! Usando armazenamento local durante o jogo.');
});

// Carregar dados do Django para JavaScript
function loadGameData() {
    // Carregar jogadores do Django
    playingPlayers = [
        {% for player in playing_players %}
        {
            id: {{ player.player.id }},
            name: "{{ player.player.user.full_name|default:player.player.user.username }}",
            position: "{{ player.player.get_position_display }}",
            type: "{{ player.player.position }}"
        },
        {% endfor %}
    ];
    
    benchPlayers = [
        {% for player in bench_players %}
        {
            id: {{ player.player.id }},
            name: "{{ player.player.user.full_name|default:player.player.user.username }}",
            position: "{{ player.player.get_position_display }}",
            type: "{{ player.player.position }}"
        },
        {% endfor %}
    ];
    
    // Tentar carregar dados salvos localmente
    const savedData = localStorage.getItem(`game_${GAME_ID}_data`);
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            evaluationData = data.evaluationData || {};
            playerTimes = data.playerTimes || {};
            substitutionData = data.substitutionData || [];
            gameTimer.elapsed = data.gameTimer?.elapsed || 0;
            
            console.log('üìÅ Dados locais carregados:', data);
        } catch (e) {
            console.error('Erro ao carregar dados locais:', e);
        }
    }
    
    // Inicializar dados de avalia√ß√£o se n√£o existirem
    [...playingPlayers, ...benchPlayers].forEach(player => {
        if (!evaluationData[player.id]) {
            evaluationData[player.id] = {
                positivo: {},
                especial: {},
                negativo: {},
                timeline: []
            };
        }
        if (!playerTimes[player.id]) {
            playerTimes[player.id] = {
                totalTime: 0,
                sessions: []
            };
        }
    });
    
    // Inicializar sess√µes de tempo para jogadores em campo
    playingPlayers.forEach(player => {
        const hasActiveSessions = playerTimes[player.id].sessions.some(s => !s.end);
        if (!hasActiveSessions) {
            playerTimes[player.id].sessions.push({
                start: Date.now(),
                end: null
            });
        }
    });
}

// Event Listeners - BASEADO NO SISTEMA ORIGINAL
function setupEventListeners() {
    // Controles do timer
    document.getElementById('playPauseBtn').addEventListener('click', toggleGameTimer);
    document.getElementById('resetTimer').addEventListener('click', function() {
        if (confirm('Reiniciar cron√¥metro? (Os dados dos jogadores n√£o ser√£o perdidos)')) {
            resetGameTimer();
        }
    });
    
    // Sele√ß√£o de jogador para avaliar
    document.getElementById('playingPlayersRow').addEventListener('click', function(e) {
        const btn = e.target.closest('.player-select-btn');
        if (!btn) return;

        const playerId = parseInt(btn.dataset.playerId);
        const playerName = btn.dataset.playerName;
        const playerType = btn.dataset.playerType;
        
        currentPlayer = playingPlayers.find(p => p.id === playerId);
        
        // Atualizar interface
        document.querySelectorAll('.player-select-btn').forEach(b => {
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline-primary');
        });
        btn.classList.add('btn-primary');
        btn.classList.remove('btn-outline-primary');
        
        showCriteriaForPlayer(currentPlayer);
    });
    
    // Clique nos crit√©rios - EFEITOS ORIGINAIS
    document.addEventListener('click', function(e) {
        if (e.target.closest('.criteria-btn')) {
            const btn = e.target.closest('.criteria-btn');
            const criteria = btn.dataset.criteria;
            const category = btn.dataset.category;
            const points = parseInt(btn.dataset.points);
            
            if (currentPlayer && gameTimer.isRunning) {
                addEvaluation(currentPlayer.id, criteria, category, points);
                
                // Efeito visual INCR√çVEL - IGUAL AO ORIGINAL
                showClickEffect(btn, points);
                
                // Atualizar stats em tempo real
                renderPlayingPlayers();
                
                // Salvar localmente
                saveDataLocally();
            } else if (!gameTimer.isRunning) {
                alert('‚è∞ Aperte PLAY no cron√¥metro para come√ßar a avaliar!');
            }
        }
    });
    
    // Substitui√ß√µes
    document.getElementById('makeSubstitutionBtn').addEventListener('click', openSubstitutionModal);
    document.getElementById('confirmSubstitution').addEventListener('click', confirmSubstitution);
}

// Timer functions - IGUAL AO ORIGINAL
function toggleGameTimer() {
    const btn = document.getElementById('playPauseBtn');
    const statusEl = document.getElementById('gameStatus');
    
    if (gameTimer.isRunning) {
        pauseGameTimer();
        btn.innerHTML = '<i class="fas fa-play"></i>';
        statusEl.textContent = 'Pausado';
    } else {
        startGameTimer();
        btn.innerHTML = '<i class="fas fa-pause"></i>';
        statusEl.textContent = 'Em andamento';
    }
}

function startGameTimer() {
    gameTimer.startTime = Date.now() - gameTimer.elapsed;
    gameTimer.isRunning = true;
    gameTimer.interval = setInterval(updateTimerDisplay, 1000);
}

function pauseGameTimer() {
    gameTimer.isRunning = false;
    if (gameTimer.interval) {
        clearInterval(gameTimer.interval);
    }
    if (gameTimer.startTime) {
        gameTimer.elapsed = Date.now() - gameTimer.startTime;
    }
}

function resetGameTimer() {
    pauseGameTimer();
    gameTimer.elapsed = 0;
    gameTimer.startTime = null;
    updateTimerDisplay();
    document.getElementById('gameStatus').textContent = 'Parado';
    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
    
    saveDataLocally();
}

function updateTimerDisplay() {
    if (gameTimer.isRunning && gameTimer.startTime) {
        gameTimer.elapsed = Date.now() - gameTimer.startTime;
    }
    
    const totalSeconds = Math.floor(gameTimer.elapsed / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    document.getElementById('gameTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Renderizar jogadores - COM STATS ATUALIZADAS
function renderPlayingPlayers() {
    const row = document.getElementById('playingPlayersRow');
    row.innerHTML = '';

    playingPlayers.forEach(player => {
        const playerTime = calculatePlayerTime(player.id);
        const playerStats = getPlayerStats(player.id);
        
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 mb-2';
        col.innerHTML = `
            <button class="btn btn-outline-primary w-100 player-select-btn" 
                    data-player-id="${player.id}"
                    data-player-name="${player.name}"
                    data-player-type="${player.type}">
                <div><strong>${player.name}</strong></div>
                <div><small class="text-muted">${player.position}</small></div>
                <div class="playing-time">‚è±Ô∏è ${playerTime}</div>
                <div class="player-stats">
                    <span class="text-success">${playerStats.positive}</span> |
                    <span class="text-warning">‚òÖ${playerStats.special}</span> |
                    <span class="text-danger">${playerStats.negative}</span>
                </div>
            </button>
        `;
        row.appendChild(col);
    });
}

// Mostrar crit√©rios - IGUAL AO ORIGINAL
function showCriteriaForPlayer(player) {
    document.getElementById('selectedPlayerName').textContent = player.name;
    document.getElementById('playerPosition').textContent = player.position;
    document.getElementById('criteriaSection').style.display = 'block';
    
    // Mostrar crit√©rios espec√≠ficos baseado no tipo do jogador
    if (player.type === 'goalkeeper') {
        document.getElementById('fieldPlayerCriteria').style.display = 'none';
        document.getElementById('goalkeeperCriteria').style.display = 'block';
    } else {
        document.getElementById('fieldPlayerCriteria').style.display = 'block';
        document.getElementById('goalkeeperCriteria').style.display = 'none';
    }
}

// Adicionar avalia√ß√£o - SALVAMENTO LOCAL
function addEvaluation(playerId, criteria, category, points) {
    if (!evaluationData[playerId]) {
        evaluationData[playerId] = {
            positivo: {},
            especial: {},
            negativo: {},
            timeline: []
        };
    }

    if (!evaluationData[playerId][category][criteria]) {
        evaluationData[playerId][category][criteria] = 0;
    }

    evaluationData[playerId][category][criteria] += points;
    
    // Registrar na timeline
    evaluationData[playerId].timeline.push({
        time: gameTimer.elapsed,
        criteria: criteria,
        category: category,
        points: points,
        timestamp: new Date().toISOString(),
        gameTime: document.getElementById('gameTimer').textContent
    });

    console.log(`‚úÖ Avalia√ß√£o adicionada: ${criteria} (${points}) para jogador ${playerId}`);
}

// Calcular estat√≠sticas - IGUAL AO ORIGINAL
function getPlayerStats(playerId) {
    const playerData = evaluationData[playerId] || {positivo: {}, especial: {}, negativo: {}};
    
    return {
        positive: Object.values(playerData.positivo).reduce((sum, val) => sum + val, 0),
        special: Object.values(playerData.especial).reduce((sum, val) => sum + val, 0),
        negative: Math.abs(Object.values(playerData.negativo).reduce((sum, val) => sum + val, 0))
    };
}

// Calcular tempo de jogo - IGUAL AO ORIGINAL
function calculatePlayerTime(playerId) {
    if (!playerTimes[playerId]) return '00:00';
    
    let totalMs = playerTimes[playerId].totalTime;
    
    // Adicionar sess√£o atual se estiver jogando
    if (playingPlayers.some(p => p.id === playerId)) {
        const currentSession = playerTimes[playerId].sessions.find(s => !s.end);
        if (currentSession && gameTimer.isRunning) {
            totalMs += Date.now() - currentSession.start;
        }
    }

    const minutes = Math.floor(totalMs / 60000);
    const seconds = Math.floor((totalMs % 60000) / 1000);
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Efeitos visuais - IGUAL AO ORIGINAL
function showClickEffect(btn, points) {
    const originalClasses = btn.className;
    
    btn.classList.add('clicked');
    btn.classList.add('pulse');
    
    if (points === 2) {
        createConfetti(btn);
    }
    
    if (navigator.vibrate) {
        if (points === 2) {
            navigator.vibrate([100, 50, 100]);
        } else {
            navigator.vibrate(50);
        }
    }
    
    setTimeout(() => {
        btn.className = originalClasses;
    }, 500);
}

function createConfetti(btn) {
    const rect = btn.getBoundingClientRect();
    const colors = ['#ffc107', '#28a745', '#dc3545', '#007bff', '#fd7e14'];
    
    for (let i = 0; i < 8; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = (rect.left + Math.random() * rect.width) + 'px';
            confetti.style.top = rect.top + 'px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.position = 'fixed';
            confetti.style.zIndex = '9999';
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                if (document.body.contains(confetti)) {
                    document.body.removeChild(confetti);
                }
            }, 600);
        }, i * 50);
    }
}

// Substitui√ß√µes - SEM RECARREGAR P√ÅGINA
function openSubstitutionModal() {
    const modal = new bootstrap.Modal(document.getElementById('substitutionModal'));
    
    // Preencher jogadores em campo
    const playersOutDiv = document.getElementById('playersToSubOut');
    playersOutDiv.innerHTML = '';
    playingPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="form-check mb-2">
                <input class="form-check-input player-out-radio" type="radio" name="playerOut" value="${player.id}" id="out${player.id}">
                <label class="form-check-label" for="out${player.id}">
                    ${player.name} (${player.position})
                </label>
            </div>
        `;
        playersOutDiv.appendChild(div);
    });

    // Preencher jogadores no banco
    const playersInDiv = document.getElementById('playersToSubIn');
    playersInDiv.innerHTML = '';
    benchPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="form-check mb-2">
                <input class="form-check-input player-in-radio" type="radio" name="playerIn" value="${player.id}" id="in${player.id}">
                <label class="form-check-label" for="in${player.id}">
                    ${player.name} (${player.position})
                </label>
            </div>
        `;
        playersInDiv.appendChild(div);
    });

    // Event listeners para os radios
    document.querySelectorAll('.player-out-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedPlayerOut = parseInt(this.value);
            checkSubstitutionReady();
        });
    });

    document.querySelectorAll('.player-in-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedPlayerIn = parseInt(this.value);
            checkSubstitutionReady();
        });
    });

    modal.show();
}

function checkSubstitutionReady() {
    const confirmBtn = document.getElementById('confirmSubstitution');
    confirmBtn.disabled = !(selectedPlayerOut && selectedPlayerIn);
}

function confirmSubstitution() {
    if (selectedPlayerOut && selectedPlayerIn) {
        // Finalizar tempo do jogador que sai
        const currentTime = Date.now();
        if (playerTimes[selectedPlayerOut]) {
            const currentSession = playerTimes[selectedPlayerOut].sessions.find(s => !s.end);
            if (currentSession) {
                currentSession.end = currentTime;
                playerTimes[selectedPlayerOut].totalTime += currentTime - currentSession.start;
            }
        }

        // Iniciar tempo do jogador que entra
        if (!playerTimes[selectedPlayerIn]) {
            playerTimes[selectedPlayerIn] = {
                totalTime: 0,
                sessions: []
            };
        }
        playerTimes[selectedPlayerIn].sessions.push({
            start: currentTime,
            end: null
        });

        // Fazer a substitui√ß√£o nos arrays
        const playerOut = playingPlayers.find(p => p.id === selectedPlayerOut);
        const playerIn = benchPlayers.find(p => p.id === selectedPlayerIn);

        playingPlayers = playingPlayers.filter(p => p.id !== selectedPlayerOut);
        benchPlayers = benchPlayers.filter(p => p.id !== selectedPlayerIn);
        
        playingPlayers.push(playerIn);
        benchPlayers.push(playerOut);

        // Registrar substitui√ß√£o
        substitutionData.push({
            time: gameTimer.elapsed,
            playerOut: playerOut.name,
            playerIn: playerIn.name,
            timestamp: new Date().toISOString()
        });

        // Atualizar interface SEM RECARREGAR
        renderPlayingPlayers();
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('substitutionModal')).hide();
        
        // Reset sele√ß√µes
        selectedPlayerOut = null;
        selectedPlayerIn = null;

        // Salvar dados
        saveDataLocally();
        
        console.log(`üîÑ Substitui√ß√£o: ${playerOut.name} ‚áÑ ${playerIn.name}`);
    }
}

// Salvar dados localmente - INDICADOR VISUAL
function saveDataLocally() {
    const dataToSave = {
        gameId: GAME_ID,
        gameTitle: GAME_TITLE,
        evaluationData,
        playerTimes,
        substitutionData,
        gameTimer: {
            elapsed: gameTimer.elapsed,
            isRunning: gameTimer.isRunning
        },
        playingPlayers,
        benchPlayers,
        lastSave: new Date().toISOString()
    };
    
    localStorage.setItem(`game_${GAME_ID}_data`, JSON.stringify(dataToSave));
    
    // Mostrar indicador de salvamento
    const indicator = document.getElementById('saveIndicator');
    indicator.style.opacity = '1';
    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 2000);
}

// Ver resultados - COM SCROLL CORRIGIDO
function viewResults() {
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const content = document.getElementById('resultsContent');
    
    // Calcular ranking
    const playersWithScores = [...playingPlayers, ...benchPlayers].map(player => {
        const stats = getPlayerStats(player.id);
        const playTime = calculatePlayerTime(player.id);
        
        const totalScore = stats.positive + stats.special - stats.negative;

        return {
            ...player,
            scores: {
                positive: stats.positive,
                special: stats.special,
                negative: stats.negative,
                total: totalScore
            },
            playTime: playTime,
            isPlaying: playingPlayers.some(p => p.id === player.id)
        };
    }).sort((a, b) => b.scores.total - a.scores.total);

    // Renderizar ranking
    content.innerHTML = playersWithScores.map((player, index) => {
        let rankBadge = '';
        if (index === 0) rankBadge = '<span class="badge bg-warning fs-6">ü•á 1¬∫</span>';
        else if (index === 1) rankBadge = '<span class="badge bg-secondary fs-6">ü•à 2¬∫</span>';
        else if (index === 2) rankBadge = '<span class="badge bg-success fs-6">ü•â 3¬∫</span>';
        else rankBadge = `<span class="badge bg-light text-dark fs-6">${index + 1}¬∫</span>`;

        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-4">
                            ${rankBadge}
                            <h5 class="mb-1">${player.name}</h5>
                            <small class="text-muted">${player.position}</small>
                            ${player.isPlaying ? '<span class="badge bg-success ms-2">Em Campo</span>' : '<span class="badge bg-secondary ms-2">No Banco</span>'}
                            <div class="mt-1">
                                <small class="text-info">‚è±Ô∏è ${player.playTime}</small>
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="p-2 bg-success text-white rounded">
                                        <small>Boas</small><br>
                                        <strong>+${player.scores.positive}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-warning text-dark rounded">
                                        <small>Impacto</small><br>
                                        <strong>‚òÖ${player.scores.special}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-danger text-white rounded">
                                        <small>Erros</small><br>
                                        <strong>-${player.scores.negative}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div class="p-2 bg-primary text-white rounded">
                                    <small>TOTAL</small><br>
                                    <strong style="font-size: 1.5rem;">${player.scores.total}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Mostrar substitui√ß√µes se houver
    if (substitutionData.length > 0) {
        content.innerHTML += `
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-exchange-alt"></i> Substitui√ß√µes Realizadas</h6>
                </div>
                <div class="card-body">
                    ${substitutionData.map(sub => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>${Math.floor(sub.time / 60000)}:${Math.floor((sub.time % 60000) / 1000).toString().padStart(2, '0')}</span>
                            <span><strong>${sub.playerOut}</strong> ‚áÑ <strong>${sub.playerIn}</strong></span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    modal.show();
}

// Finalizar e salvar no Django
function finishAndSaveGame() {
    if (!confirm('üèÅ Finalizar e salvar o jogo no banco de dados?\n\nTodas as avalia√ß√µes ser√£o permanentemente registradas.')) {
        return;
    }
    
    // Pausar timer
    if (gameTimer.isRunning) {
        pauseGameTimer();
    }
    
    // Mostrar loading
    const btn = document.querySelector('[onclick="finishAndSaveGame()"]');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    btn.disabled = true;
    
    // Preparar dados para envio
    const gameData = {
        game_id: GAME_ID,
        duration: Math.floor(gameTimer.elapsed / 1000),
        status: 'finished',
        evaluation_data: evaluationData,
        player_times: playerTimes,
        substitutions: substitutionData,
        playing_players: playingPlayers.map(p => p.id),
        bench_players: benchPlayers.map(p => p.id)
    };
    
    // Enviar para Django
    fetch('{% url 'core:api_save_complete_game' %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(gameData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Limpar dados locais
            localStorage.removeItem(`game_${GAME_ID}_data`);
            
            alert('‚úÖ Jogo salvo com sucesso!\n\n' + 
                  `Total de avalia√ß√µes: ${data.total_evaluations}\n` +
                  `Substitui√ß√µes: ${data.total_substitutions}`);
            
            // Redirecionar para detalhes do jogo
            window.location.href = `{% url 'core:game_detail' game.id %}`;
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('Erro ao salvar:', error);
        alert('‚ùå Erro ao salvar o jogo:\n' + error.message + '\n\nOs dados continuam salvos localmente.');
        
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    });
}

// Exportar dados locais
function exportGameData() {
    const dataToExport = {
        resumo_jogo: {
            titulo: GAME_TITLE,
            data: new Date().toLocaleString('pt-BR'),
            tempo_total: document.getElementById('gameTimer').textContent,
            total_avaliacoes: Object.values(evaluationData).reduce((total, player) => {
                return total + (player.timeline ? player.timeline.length : 0);
            }, 0)
        },
        evaluation_data: evaluationData,
        player_times: playerTimes,
        substitutions: substitutionData,
        playing_players: playingPlayers,
        bench_players: benchPlayers
    };

    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${GAME_TITLE.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Utility function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Debug function
window.debugGame = function() {
    console.log('üîç Estado atual do jogo:');
    console.log('Timer:', gameTimer);
    console.log('Jogador atual:', currentPlayer);
    console.log('Avalia√ß√µes:', evaluationData);
    console.log('Tempos:', playerTimes);
    console.log('Substitui√ß√µes:', substitutionData);
};

console.log('‚úÖ Sistema de avalia√ß√£o carregado! Use debugGame() para debug.');
</script>
{% endblock %}