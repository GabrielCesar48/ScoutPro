{% extends 'base.html' %}

{% block title %}Avaliação - {{ game.title }} - ScoutPro{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --surface: #ffffff;
        --surface-variant: #f8fafc;
        --on-surface: #1e293b;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    body {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    /* HEADER PRINCIPAL REDESENHADO */
    .evaluation-header {
        background: var(--info-gradient);
        color: white;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
    }
    
    .evaluation-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.3;
    }
    
    .game-title {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(255,255,255,0.2);
        position: relative;
        z-index: 1;
    }
    
    .game-title h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .game-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 5px;
        font-weight: 500;
    }
    
    /* PLACAR PRINCIPAL REDESENHADO */
    .main-scoreboard {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    
    .scoreboard-container {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 20px;
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(255,255,255,0.2);
        min-width: 320px;
    }
    
    .score-display {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .team-section, .opponent-section {
        flex: 1;
        text-align: center;
    }
    
    .team-label, .opponent-label {
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0.9;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .score-number {
        font-size: 3rem;
        font-weight: 900;
        line-height: 1;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }
    
    .score-vs {
        font-size: 1.2rem;
        font-weight: bold;
        opacity: 0.8;
        margin: 0 20px;
        align-self: center;
    }
    
    .opponent-controls {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 10px;
    }
    
    .opponent-controls .btn {
        background: var(--warning-gradient);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-md);
    }
    
    .opponent-controls .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }
    
    /* CONTROLES CENTRALIZADOS */
    .game-controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        position: relative;
        z-index: 1;
    }
    
    .timer-section {
        text-align: center;
    }
    
    .timer-display {
        font-size: 2.5rem;
        font-weight: 900;
        font-family: 'Courier New', monospace;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        margin-bottom: 5px;
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 1rem;
        border-radius: 12px;
        backdrop-filter: blur(5px);
    }
    
    .timer-status {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
    }
    
    .control-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .control-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        min-width: 50px;
        backdrop-filter: blur(5px);
        text-decoration: none;
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.3);
        border-color: rgba(255,255,255,0.5);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
    }
    
    .control-btn.btn-play {
        background: var(--success-gradient);
        border-color: transparent;
    }
    
    .control-btn.btn-pause {
        background: var(--warning-gradient);
        border-color: transparent;
    }
    
    .control-btn.btn-danger {
        background: var(--danger-gradient);
        border-color: transparent;
    }
    
    /* Save Indicator */
    .save-indicator {
        position: fixed;
        top: 90px;
        right: 20px;
        background: var(--success-gradient);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: var(--shadow-lg);
    }
    
    /* ANIMAÇÕES MELHORADAS */
    .goal-animation {
        animation: goalCelebration 1.2s ease-out;
    }
    
    @keyframes goalCelebration {
        0% { transform: scale(1); }
        20% { transform: scale(1.2); color: #ffd700; }
        40% { transform: scale(1.1); }
        60% { transform: scale(1.15); color: #ff6b35; }
        80% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pulse-effect {
        animation: pulse 0.6s ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255,255,255,0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }

    /* Instructions Alert */
    .alert {
        border: none;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
    }
    
    .alert-info {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
        border-left: 4px solid #4facfe;
    }
    
    /* JOGADORES MODERNIZADOS */
    .players-section {
        background: var(--surface);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-lg);
    }

    .players-section h5 {
        color: var(--on-surface);
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .player-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border-radius: 16px;
        margin-bottom: 0.75rem;
        box-shadow: var(--shadow-md);
        border: 2px solid var(--border-color);
        background: var(--surface);
    }
    
    .player-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .player-card.active {
        border: 3px solid #11998e;
        background: linear-gradient(135deg, rgba(17, 153, 142, 0.1), rgba(56, 239, 125, 0.05));
        transform: translateY(-2px);
    }
    
    .playing-time {
        font-size: 0.8rem;
        color: #11998e;
        font-weight: 600;
        background: rgba(17, 153, 142, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        display: inline-block;
    }
    
    .player-stats {
        font-size: 0.8rem;
        background: var(--surface-variant);
        border-radius: 8px;
        padding: 5px 8px;
        margin-top: 5px;
        font-weight: 500;
    }
    
    /* CRITÉRIOS MODERNIZADOS */
    .criteria-section {
        background: var(--surface);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-lg);
    }

    .criteria-btn {
        margin: 3px;
        min-height: 80px;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-md);
        border: 2px solid var(--border-color);
        font-weight: 600;
    }
    
    .criteria-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: rgba(102, 126, 234, 0.3);
    }
    
    .criteria-btn.clicked {
        transform: scale(0.95);
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
        background: var(--success-gradient) !important;
        color: white !important;
        border-color: transparent !important;
    }
    
    .criteria-btn.clicked.special {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.8);
        background: var(--warning-gradient) !important;
    }
    
    .criteria-btn.clicked.negative {
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
        background: var(--danger-gradient) !important;
    }
    
    .category-header {
        background: var(--success-gradient);
        color: white;
        margin: 15px 0 10px 0;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .category-header.negative {
        background: var(--danger-gradient);
    }
    
    .category-header.special {
        background: var(--warning-gradient);
    }

    /* Modals */
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        border-radius: 20px 20px 0 0;
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
        border-radius: 0 0 20px 20px;
    }

    .results-modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    /* EFEITOS ESPECIAIS */
    .confetti-burst {
        position: fixed;
        pointer-events: none;
        z-index: 1000;
    }
    
    .confetti-piece {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #ffd700;
        animation: confetti-fall 1.5s ease-out forwards;
    }
    
    @keyframes confetti-fall {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(150px) rotate(360deg); opacity: 0; }
    }

    @keyframes confetti {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(-50px) rotate(360deg); opacity: 0; }
    }
    
    .confetti {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #ffd700;
        animation: confetti 0.8s ease-out;
        pointer-events: none;
    }

    /* Fade in animation */
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* RESPONSIVIDADE MOBILE */
    @media (max-width: 768px) {
        .evaluation-header {
            padding: 15px;
            border-radius: 15px;
        }
        
        .game-title h3 {
            font-size: 1.3rem;
        }
        
        .scoreboard-container {
            min-width: 280px;
            padding: 15px;
        }
        
        .score-number {
            font-size: 2.5rem;
        }
        
        .timer-display {
            font-size: 2rem;
        }
        
        .control-btn {
            padding: 10px 12px;
            font-size: 0.9rem;
            min-width: 45px;
        }
        
        .criteria-btn {
            min-height: 70px;
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 576px) {
        .evaluation-header {
            padding: 12px;
        }
        
        .scoreboard-container {
            min-width: 260px;
            padding: 12px;
        }
        
        .score-number {
            font-size: 2.2rem;
        }
        
        .timer-display {
            font-size: 1.8rem;
        }
        
        .criteria-btn {
            min-height: 60px;
            font-size: 0.85rem;
        }
        
        .score-vs {
            margin: 0 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Save Indicator -->
<div id="saveIndicator" class="save-indicator">
    <i class="fas fa-save"></i> Dados salvos localmente
</div>

<!-- HEADER REDESENHADO -->
<div class="evaluation-header fade-in">
    <!-- TÍTULO CENTRALIZADO -->
    <div class="game-title">
        <h3>{{ game.title }}</h3>
        <div class="game-subtitle">Avaliação em Tempo Real</div>
    </div>
    
    <!-- PLACAR PRINCIPAL -->
    <div class="main-scoreboard">
        <div class="scoreboard-container">
            <div class="score-display">
                <div class="team-section">
                    <div class="team-label">Nosso Time</div>
                    <div class="score-number" id="teamScore">{{ game.team_goals|default:0 }}</div>
                </div>
                
                <div class="score-vs">×</div>
                
                <div class="opponent-section">
                    <div class="opponent-label">{{ game.opponent|default:"Adversário" }}</div>
                    <div class="score-number" id="opponentScore">{{ game.opponent_goals|default:0 }}</div>
                    <div class="opponent-controls">
                        <button class="btn" onclick="changeOpponentScore('add')" title="Adicionar gol do adversário">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn" onclick="changeOpponentScore('remove')" title="Remover gol do adversário">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CONTROLES CENTRALIZADOS -->
    <div class="game-controls">
        <div class="timer-section">
            <div class="timer-display" id="gameTimer">00:00</div>
            <div class="timer-status" id="gameStatus">Parado</div>
        </div>
        
        <div class="control-buttons">
            <button id="playPauseBtn" class="control-btn btn-play" onclick="toggleGameTimer()" title="Iniciar/Pausar">
                <i class="fas fa-play"></i>
            </button>
            <button class="control-btn" onclick="resetGameTimer()" title="Resetar cronômetro">
                <i class="fas fa-stop"></i>
            </button>
            <button class="control-btn" onclick="openSubstitutionModal()" title="Fazer substituição">
                <i class="fas fa-exchange-alt"></i>
            </button>
            <button class="control-btn" onclick="viewResults()" title="Ver resultados">
                <i class="fas fa-chart-bar"></i>
            </button>
            <button class="control-btn btn-danger" onclick="finishAndSaveGame()" title="Finalizar jogo">
                <i class="fas fa-save"></i>
            </button>
            <a href="{% url 'core:game_detail' game.pk %}" class="control-btn" title="Voltar">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>
</div>

<!-- INSTRUÇÕES -->
<div class="row mb-3 fade-in">
    <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i>
            <strong>Instruções:</strong> Clique em um jogador para avaliá-lo. Use o cronômetro para controlar o tempo de jogo.
        </div>
    </div>
</div>

<!-- Jogadores em Campo -->
<div class="players-section fade-in">
    <h5><i class="fas fa-running text-success"></i> Jogadores em Campo</h5>
    <div class="row" id="playingPlayersRow">
        {% for player in playing_players %}
        <div class="col-6 col-md-4 mb-2">
            <button class="btn btn-outline-primary w-100 player-select-btn player-card" 
                    data-player-id="{{ player.player.id }}"
                    data-player-name="{{ player.player.user.full_name|default:player.player.user.username }}"
                    data-player-type="{{ player.player.position }}">
                <div><strong>{{ player.player.user.full_name|default:player.player.user.username }}</strong></div>
                <div><small class="text-muted">{{ player.player.get_position_display }}</small></div>
                <div class="playing-time">⏱️ 00:00</div>
                <div class="player-stats">
                    <span class="text-success">0</span> |
                    <span class="text-warning">★0</span> |
                    <span class="text-danger">0</span>
                </div>
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Jogadores Reservas -->
{% if bench_players %}
<div class="players-section fade-in">
    <h5><i class="fas fa-chair text-secondary"></i> Jogadores Reservas</h5>
    <div class="row">
        {% for player in bench_players %}
        <div class="col-6 col-md-4 mb-2">
            <button class="btn btn-outline-secondary w-100 player-card" 
                    data-player-id="{{ player.player.id }}"
                    data-player-name="{{ player.player.user.full_name|default:player.player.user.username }}"
                    data-player-type="{{ player.player.position }}">
                <div><strong>{{ player.player.user.full_name|default:player.player.user.username }}</strong></div>
                <div><small class="text-muted">{{ player.player.get_position_display }}</small></div>
                <div class="playing-time">No banco</div>
                <div class="player-stats">
                    <span class="text-muted">Reserva</span>
                </div>
            </button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Critérios de Avaliação -->
<div id="criteriaSection" style="display: none;" class="criteria-section fade-in">
    <div class="row">
        <div class="col-12">
            <h5 class="text-center mb-3">
                Avaliar: <span id="selectedPlayerName" class="text-primary"></span>
                <span id="playerPosition" class="badge bg-secondary"></span>
            </h5>
        </div>
    </div>

    <!-- Critérios para Jogadores de Linha -->
    <div id="fieldPlayerCriteria" style="display: none;">
        <div class="category-header">
            <i class="fas fa-thumbs-up"></i>
            <h6 class="mb-0">AÇÃO BOA (+1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success criteria-btn w-100 mb-2" 
                        data-criteria="acao_boa" 
                        data-category="positivo" 
                        data-points="1" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-check-circle fa-2x"></i><br>
                    <strong>AÇÃO BOA</strong><br>
                    <small>Jogada ofensiva, passe decisivo, recuperação importante</small>
                </button>
            </div>
        </div>

        <div class="category-header special">
            <i class="fas fa-star"></i>
            <h6 class="mb-0">IMPACTO NO JOGO (+2)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="gol" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1rem;">
                    <i class="fas fa-futbol fa-2x"></i><br>
                    <strong>GOL!</strong>
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="assistencia" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1rem;">
                    <i class="fas fa-hands-helping fa-2x"></i><br>
                    <strong>ASSISTÊNCIA</strong>
                </button>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="jogada_genial" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1rem;">
                    <i class="fas fa-brain fa-2x"></i><br>
                    <strong>JOGADA GENIAL</strong><br>
                    <small>Drible espetacular, passe impossível, decisão brilhante</small>
                </button>
            </div>
        </div>

        <div class="category-header negative">
            <i class="fas fa-thumbs-down"></i>
            <h6 class="mb-0">ERRO (-1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-danger criteria-btn w-100 mb-2" 
                        data-criteria="erro" 
                        data-category="negativo" 
                        data-points="-1" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-times-circle fa-2x"></i><br>
                    <strong>ERRO</strong><br>
                    <small>Perda de bola perigosa, falta boba, chance perdida</small>
                </button>
            </div>
        </div>
    </div>

    <!-- Critérios Específicos para Goleiros -->
    <div id="goalkeeperCriteria" style="display: none;">
        <div class="category-header">
            <i class="fas fa-shield-alt"></i>
            <h6 class="mb-0">DEFESA BOA (+1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success criteria-btn w-100 mb-2" 
                        data-criteria="defesa_boa" 
                        data-category="positivo" 
                        data-points="1" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-hand-paper fa-2x"></i><br>
                    <strong>DEFESA BOA</strong><br>
                    <small>Salvou o chute, saída no tempo certo, reposição rápida</small>
                </button>
            </div>
        </div>

        <div class="category-header special">
            <i class="fas fa-star"></i>
            <h6 class="mb-0">DEFESA SALVADORA (+2)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-warning criteria-btn w-100 mb-2" 
                        data-criteria="defesa_salvadora" 
                        data-category="especial" 
                        data-points="2" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-medal fa-2x"></i><br>
                    <strong>DEFESA SALVADORA</strong><br>
                    <small>Defesa espetacular, salvou gol certo</small>
                </button>
            </div>
        </div>

        <div class="category-header negative">
            <i class="fas fa-exclamation-triangle"></i>
            <h6 class="mb-0">FALHA (-1)</h6>
        </div>
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-danger criteria-btn w-100 mb-2" 
                        data-criteria="falha_goleiro" 
                        data-category="negativo" 
                        data-points="-1" 
                        style="min-height: 80px; font-size: 1.1rem;">
                    <i class="fas fa-times-circle fa-2x"></i><br>
                    <strong>FALHA</strong><br>
                    <small>Saída errada, passe errado, gol por falha</small>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Substituição -->
<div class="modal fade" id="substitutionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt"></i> Fazer Substituição
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Sai de Campo:</h6>
                        <div id="playersToSubOut">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                    </div>
                    <div class="col-6">
                        <h6>Entra no Jogo:</h6>
                        <div id="playersToSubIn">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmSubstitution" disabled>
                    <i class="fas fa-check"></i> Confirmar Substituição
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Resultados -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trophy text-warning"></i>
                    Resultados do Jogo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body results-modal-body">
                <div id="resultsContent">
                    <!-- Resultados serão inseridos aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="exportGameData()">
                    <i class="fas fa-download"></i> Exportar Dados
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============= SISTEMA DE AVALIAÇÃO COM DESIGN MELHORADO =============

// Estado da aplicação
let selectedPlayers = [];
let playingPlayers = [];
let benchPlayers = [];
let currentPlayer = null;
let evaluationData = {};
let playerTimes = {};
let gameTimer = {
    startTime: null,
    elapsed: 0,
    isRunning: false,
    interval: null
};
let substitutionData = [];
let selectedPlayerOut = null;
let selectedPlayerIn = null;

// Dados do jogo Django
const GAME_ID = {{ game.id }};
const GAME_TITLE = "{{ game.title }}";

// ============= INICIALIZAÇÃO =============
document.addEventListener('DOMContentLoaded', function() {
    loadGameData();
    setupEventListeners();
    renderPlayingPlayers();
    updateTimerDisplay();
    loadSavedData();
    
    // Auto-save local a cada 10 segundos
    setInterval(function() {
        if (gameTimer.isRunning) {
            saveDataLocally();
        }
    }, 10000);
    
    // Salvar antes de sair da página
    window.addEventListener('beforeunload', function(e) {
        saveDataLocally();
        if (gameTimer.isRunning && Object.keys(evaluationData).length > 0) {
            e.preventDefault();
            e.returnValue = 'Há avaliações não salvas. Deseja realmente sair?';
        }
    });
    
    // Initialize animations
    const fadeElements = document.querySelectorAll('.fade-in');
    fadeElements.forEach((element, index) => {
        setTimeout(() => {
            element.style.animationDelay = `${index * 0.1}s`;
        }, 100);
    });
    
    console.log('🚀 Sistema carregado com design melhorado!');
});

// ============= CARREGAR DADOS DO DJANGO =============
function loadGameData() {
    playingPlayers = [
        {% for player in playing_players %}
        {
            id: {{ player.player.id }},
            name: "{{ player.player.user.full_name|default:player.player.user.username }}",
            position: "{{ player.player.get_position_display }}",
            type: "{{ player.player.position }}"
        },
        {% endfor %}
    ];
    
    benchPlayers = [
        {% for player in bench_players %}
        {
            id: {{ player.player.id }},
            name: "{{ player.player.user.full_name|default:player.player.user.username }}",
            position: "{{ player.player.get_position_display }}",
            type: "{{ player.player.position }}"
        },
        {% endfor %}
    ];
    
    // Inicializar dados
    [...playingPlayers, ...benchPlayers].forEach(player => {
        if (!evaluationData[player.id]) {
            evaluationData[player.id] = {
                positivo: {},
                especial: {},
                negativo: {},
                timeline: []
            };
        }
        if (!playerTimes[player.id]) {
            playerTimes[player.id] = {
                totalTime: 0,
                sessions: []
            };
        }
    });
    
    // Inicializar sessões de tempo
    playingPlayers.forEach(player => {
        const hasActiveSessions = playerTimes[player.id].sessions.some(s => !s.end);
        if (!hasActiveSessions) {
            playerTimes[player.id].sessions.push({
                start: Date.now(),
                end: null
            });
        }
    });
}

// ============= EVENT LISTENERS =============
function setupEventListeners() {
    // Seleção de jogador
    document.getElementById('playingPlayersRow').addEventListener('click', function(e) {
        const btn = e.target.closest('.player-select-btn');
        if (!btn) return;

        const playerId = parseInt(btn.dataset.playerId);
        currentPlayer = playingPlayers.find(p => p.id === playerId);
        
        // Atualizar interface
        document.querySelectorAll('.player-select-btn').forEach(b => {
            b.classList.remove('btn-primary', 'active');
            b.classList.add('btn-outline-primary');
        });
        btn.classList.add('btn-primary', 'active');
        btn.classList.remove('btn-outline-primary');
        
        showCriteriaForPlayer(currentPlayer);
    });
    
    // Clique nos critérios
    document.addEventListener('click', function(e) {
        if (e.target.closest('.criteria-btn')) {
            const btn = e.target.closest('.criteria-btn');
            const criteria = btn.dataset.criteria;
            const category = btn.dataset.category;
            const points = parseInt(btn.dataset.points);
            
            if (currentPlayer && gameTimer.isRunning) {
                addEvaluation(currentPlayer.id, criteria, category, points);
                showClickEffect(btn, points);
                renderPlayingPlayers();
                saveDataLocally();
            } else if (!gameTimer.isRunning) {
                alert('⏰ Aperte PLAY no cronômetro para começar a avaliar!');
            }
        }
    });
    
    // Substituições
    document.getElementById('confirmSubstitution').addEventListener('click', confirmSubstitution);
}

// ============= CONTROLE DO TIMER =============
function toggleGameTimer() {
    const btn = document.getElementById('playPauseBtn');
    const statusEl = document.getElementById('gameStatus');
    
    if (gameTimer.isRunning) {
        pauseGameTimer();
        btn.innerHTML = '<i class="fas fa-play"></i>';
        btn.classList.remove('btn-pause');
        btn.classList.add('btn-play');
        statusEl.textContent = 'Pausado';
    } else {
        startGameTimer();
        btn.innerHTML = '<i class="fas fa-pause"></i>';
        btn.classList.remove('btn-play');
        btn.classList.add('btn-pause');
        statusEl.textContent = 'Em andamento';
    }
}

function startGameTimer() {
    gameTimer.startTime = Date.now() - gameTimer.elapsed;
    gameTimer.isRunning = true;
    gameTimer.interval = setInterval(updateTimerDisplay, 1000);
}

function pauseGameTimer() {
    gameTimer.isRunning = false;
    if (gameTimer.interval) {
        clearInterval(gameTimer.interval);
    }
    if (gameTimer.startTime) {
        gameTimer.elapsed = Date.now() - gameTimer.startTime;
    }
}

function resetGameTimer() {
    if (confirm('Reiniciar cronômetro? (Os dados dos jogadores não serão perdidos)')) {
        pauseGameTimer();
        gameTimer.elapsed = 0;
        gameTimer.startTime = null;
        updateTimerDisplay();
        document.getElementById('gameStatus').textContent = 'Parado';
        document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('playPauseBtn').classList.remove('btn-pause');
        document.getElementById('playPauseBtn').classList.add('btn-play');
        saveDataLocally();
    }
}

function updateTimerDisplay() {
    if (gameTimer.isRunning && gameTimer.startTime) {
        gameTimer.elapsed = Date.now() - gameTimer.startTime;
    }
    
    const totalSeconds = Math.floor(gameTimer.elapsed / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    document.getElementById('gameTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// ============= CONTROLE DO PLACAR =============
function changeOpponentScore(action) {
    const data = {
        game_id: GAME_ID,
        action: action
    };
    
    fetch('/api/opponent-goal/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateScoreDisplay(data.team_goals, data.opponent_goals);
            
            // Animação especial para gol
            const opponentScore = document.getElementById('opponentScore');
            animateGoal(opponentScore, false);
            
            saveDataLocally();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro de conexão');
    });
}

function updateScoreDisplay(teamGoals, opponentGoals) {
    document.getElementById('teamScore').textContent = teamGoals;
    document.getElementById('opponentScore').textContent = opponentGoals;
}

function animateGoal(element, isTeamGoal = true) {
    element.classList.add('goal-animation');
    
    // Adicionar efeito pulse ao container
    const container = element.closest('.scoreboard-container');
    container.classList.add('pulse-effect');
    
    // Criar confetti
    createConfettiEffect(element);
    
    // Vibração se suportada
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200, 100, 200]);
    }
    
    // Remover classes após animação
    setTimeout(() => {
        element.classList.remove('goal-animation');
        container.classList.remove('pulse-effect');
    }, 1200);
}

function createConfettiEffect(element) {
    const rect = element.getBoundingClientRect();
    const colors = ['#ffd700', '#ff6b35', '#28a745', '#007bff', '#e74c3c'];
    
    const confettiContainer = document.createElement('div');
    confettiContainer.className = 'confetti-burst';
    confettiContainer.style.left = (rect.left + rect.width/2) + 'px';
    confettiContainer.style.top = rect.top + 'px';
    document.body.appendChild(confettiContainer);
    
    for (let i = 0; i < 15; i++) {
        setTimeout(() => {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = (Math.random() * 40 - 20) + 'px';
            piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDelay = Math.random() * 0.3 + 's';
            
            confettiContainer.appendChild(piece);
        }, i * 30);
    }
    
    setTimeout(() => {
        if (document.body.contains(confettiContainer)) {
            document.body.removeChild(confettiContainer);
        }
    }, 1500);
}

// ============= RENDERIZAÇÃO =============
function renderPlayingPlayers() {
    const row = document.getElementById('playingPlayersRow');
    row.innerHTML = '';

    playingPlayers.forEach(player => {
        const playerTime = calculatePlayerTime(player.id);
        const playerStats = getPlayerStats(player.id);
        
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 mb-2';
        col.innerHTML = `
            <button class="btn btn-outline-primary w-100 player-select-btn player-card" 
                    data-player-id="${player.id}"
                    data-player-name="${player.name}"
                    data-player-type="${player.type}">
                <div><strong>${player.name}</strong></div>
                <div><small class="text-muted">${player.position}</small></div>
                <div class="playing-time">⏱️ ${playerTime}</div>
                <div class="player-stats">
                    <span class="text-success">${playerStats.positive}</span> |
                    <span class="text-warning">★${playerStats.special}</span> |
                    <span class="text-danger">${playerStats.negative}</span>
                </div>
            </button>
        `;
        row.appendChild(col);
    });
}

function showCriteriaForPlayer(player) {
    document.getElementById('selectedPlayerName').textContent = player.name;
    document.getElementById('playerPosition').textContent = player.position;
    document.getElementById('criteriaSection').style.display = 'block';
    
    if (player.type === 'goalkeeper') {
        document.getElementById('fieldPlayerCriteria').style.display = 'none';
        document.getElementById('goalkeeperCriteria').style.display = 'block';
    } else {
        document.getElementById('fieldPlayerCriteria').style.display = 'block';
        document.getElementById('goalkeeperCriteria').style.display = 'none';
    }
    
    // Scroll suave para os critérios
    document.getElementById('criteriaSection').scrollIntoView({ behavior: 'smooth' });
}

// ============= AVALIAÇÃO =============
function addEvaluation(playerId, criteria, category, points) {
    if (!evaluationData[playerId]) {
        evaluationData[playerId] = {
            positivo: {},
            especial: {},
            negativo: {},
            timeline: []
        };
    }

    if (!evaluationData[playerId][category][criteria]) {
        evaluationData[playerId][category][criteria] = 0;
    }

    evaluationData[playerId][category][criteria] += points;
    
    evaluationData[playerId].timeline.push({
        time: gameTimer.elapsed,
        criteria: criteria,
        category: category,
        points: points,
        timestamp: new Date().toISOString(),
        gameTime: document.getElementById('gameTimer').textContent
    });

    // SE FOR GOL, ATUALIZAR PLACAR
    if (criteria === 'gol') {
        updateTeamGoals();
    }

    console.log(`✅ Avaliação adicionada: ${criteria} (${points}) para jogador ${playerId}`);
}

function updateTeamGoals() {
    const currentTeamGoals = parseInt(document.getElementById('teamScore').textContent);
    const newTeamGoals = currentTeamGoals + 1;
    
    document.getElementById('teamScore').textContent = newTeamGoals;
    
    // Animação especial para gol do time
    const teamScore = document.getElementById('teamScore');
    animateGoal(teamScore, true);
    
    // Salvar no banco
    fetch('/api/opponent-goal/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            game_id: GAME_ID,
            action: 'add',
            team_goal: true
        })
    })
    .catch(error => {
        console.error('Erro ao salvar gol no banco:', error);
    });
}

function getPlayerStats(playerId) {
    const playerData = evaluationData[playerId] || {positivo: {}, especial: {}, negativo: {}};
    
    return {
        positive: Object.values(playerData.positivo).reduce((sum, val) => sum + val, 0),
        special: Object.values(playerData.especial).reduce((sum, val) => sum + val, 0),
        negative: Math.abs(Object.values(playerData.negativo).reduce((sum, val) => sum + val, 0))
    };
}

function calculatePlayerTime(playerId) {
    if (!playerTimes[playerId]) return '00:00';
    
    let totalMs = playerTimes[playerId].totalTime;
    
    if (playingPlayers.some(p => p.id === playerId)) {
        const currentSession = playerTimes[playerId].sessions.find(s => !s.end);
        if (currentSession && gameTimer.isRunning) {
            totalMs += Date.now() - currentSession.start;
        }
    }

    const minutes = Math.floor(totalMs / 60000);
    const seconds = Math.floor((totalMs % 60000) / 1000);
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// ============= EFEITOS VISUAIS =============
function showClickEffect(btn, points) {
    const originalClasses = btn.className;
    
    btn.classList.add('clicked');
    btn.classList.add('pulse');
    
    if (points === 2) {
        createConfetti(btn);
    }
    
    if (navigator.vibrate) {
        if (points === 2) {
            navigator.vibrate([100, 50, 100]);
        } else {
            navigator.vibrate(50);
        }
    }
    
    setTimeout(() => {
        btn.className = originalClasses;
    }, 500);
}

function createConfetti(btn) {
    const rect = btn.getBoundingClientRect();
    const colors = ['#ffd700', '#28a745', '#dc3545', '#007bff', '#fd7e14'];
    
    for (let i = 0; i < 8; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = (rect.left + Math.random() * rect.width) + 'px';
            confetti.style.top = rect.top + 'px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.position = 'fixed';
            confetti.style.zIndex = '9999';
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                if (document.body.contains(confetti)) {
                    document.body.removeChild(confetti);
                }
            }, 800);
        }, i * 50);
    }
}

// ============= SUBSTITUIÇÕES =============
function openSubstitutionModal() {
    const modal = new bootstrap.Modal(document.getElementById('substitutionModal'));
    
    const playersOutDiv = document.getElementById('playersToSubOut');
    playersOutDiv.innerHTML = '';
    playingPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="form-check mb-2">
                <input class="form-check-input player-out-radio" type="radio" name="playerOut" value="${player.id}" id="out${player.id}">
                <label class="form-check-label" for="out${player.id}">
                    ${player.name} (${player.position})
                </label>
            </div>
        `;
        playersOutDiv.appendChild(div);
    });

    const playersInDiv = document.getElementById('playersToSubIn');
    playersInDiv.innerHTML = '';
    benchPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="form-check mb-2">
                <input class="form-check-input player-in-radio" type="radio" name="playerIn" value="${player.id}" id="in${player.id}">
                <label class="form-check-label" for="in${player.id}">
                    ${player.name} (${player.position})
                </label>
            </div>
        `;
        playersInDiv.appendChild(div);
    });

    document.querySelectorAll('.player-out-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedPlayerOut = parseInt(this.value);
            checkSubstitutionReady();
        });
    });

    document.querySelectorAll('.player-in-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            selectedPlayerIn = parseInt(this.value);
            checkSubstitutionReady();
        });
    });

    modal.show();
}

function checkSubstitutionReady() {
    const confirmBtn = document.getElementById('confirmSubstitution');
    confirmBtn.disabled = !(selectedPlayerOut && selectedPlayerIn);
}

function confirmSubstitution() {
    if (selectedPlayerOut && selectedPlayerIn) {
        const currentTime = Date.now();
        if (playerTimes[selectedPlayerOut]) {
            const currentSession = playerTimes[selectedPlayerOut].sessions.find(s => !s.end);
            if (currentSession) {
                currentSession.end = currentTime;
                playerTimes[selectedPlayerOut].totalTime += currentTime - currentSession.start;
            }
        }

        if (!playerTimes[selectedPlayerIn]) {
            playerTimes[selectedPlayerIn] = {
                totalTime: 0,
                sessions: []
            };
        }
        playerTimes[selectedPlayerIn].sessions.push({
            start: currentTime,
            end: null
        });

        const playerOut = playingPlayers.find(p => p.id === selectedPlayerOut);
        const playerIn = benchPlayers.find(p => p.id === selectedPlayerIn);

        playingPlayers = playingPlayers.filter(p => p.id !== selectedPlayerOut);
        benchPlayers = benchPlayers.filter(p => p.id !== selectedPlayerIn);
        
        playingPlayers.push(playerIn);
        benchPlayers.push(playerOut);

        substitutionData.push({
            time: gameTimer.elapsed,
            playerOut: playerOut.name,
            playerIn: playerIn.name,
            timestamp: new Date().toISOString()
        });

        renderPlayingPlayers();
        bootstrap.Modal.getInstance(document.getElementById('substitutionModal')).hide();
        
        selectedPlayerOut = null;
        selectedPlayerIn = null;
        saveDataLocally();
        
        console.log(`🔄 Substituição: ${playerOut.name} ⇄ ${playerIn.name}`);
    }
}

// ============= RESULTADOS =============
function viewResults() {
    const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
    const content = document.getElementById('resultsContent');
    
    const playersWithScores = [...playingPlayers, ...benchPlayers].map(player => {
        const stats = getPlayerStats(player.id);
        const playTime = calculatePlayerTime(player.id);
        
        const totalScore = stats.positive + stats.special - stats.negative;

        return {
            ...player,
            scores: {
                positive: stats.positive,
                special: stats.special,
                negative: stats.negative,
                total: totalScore
            },
            playTime: playTime,
            isPlaying: playingPlayers.some(p => p.id === player.id)
        };
    }).sort((a, b) => b.scores.total - a.scores.total);

    content.innerHTML = playersWithScores.map((player, index) => {
        let rankBadge = '';
        if (index === 0) rankBadge = '<span class="badge bg-warning fs-6">🥇 1º</span>';
        else if (index === 1) rankBadge = '<span class="badge bg-secondary fs-6">🥈 2º</span>';
        else if (index === 2) rankBadge = '<span class="badge bg-success fs-6">🥉 3º</span>';
        else rankBadge = `<span class="badge bg-light text-dark fs-6">${index + 1}º</span>`;

        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-4">
                            ${rankBadge}
                            <h5 class="mb-1">${player.name}</h5>
                            <small class="text-muted">${player.position}</small>
                            ${player.isPlaying ? '<span class="badge bg-success ms-2">Em Campo</span>' : '<span class="badge bg-secondary ms-2">No Banco</span>'}
                            <div class="mt-1">
                                <small class="text-info">⏱️ ${player.playTime}</small>
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="p-2 bg-success text-white rounded">
                                        <small>Boas</small><br>
                                        <strong>+${player.scores.positive}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-warning text-dark rounded">
                                        <small>Impacto</small><br>
                                        <strong>★${player.scores.special}</strong>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="p-2 bg-danger text-white rounded">
                                        <small>Erros</small><br>
                                        <strong>-${player.scores.negative}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 text-center">
                                <div class="p-2 bg-primary text-white rounded">
                                    <small>TOTAL</small><br>
                                    <strong style="font-size: 1.5rem;">${player.scores.total}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    if (substitutionData.length > 0) {
        content.innerHTML += `
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-exchange-alt"></i> Substituições Realizadas</h6>
                </div>
                <div class="card-body">
                    ${substitutionData.map(sub => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>${Math.floor(sub.time / 60000)}:${Math.floor((sub.time % 60000) / 1000).toString().padStart(2, '0')}</span>
                            <span><strong>${sub.playerOut}</strong> ⇄ <strong>${sub.playerIn}</strong></span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    modal.show();
}

// ============= SALVAMENTO =============
function saveDataLocally() {
    const dataToSave = {
        gameId: GAME_ID,
        gameTitle: GAME_TITLE,
        evaluationData,
        playerTimes,
        substitutionData,
        gameTimer: {
            elapsed: gameTimer.elapsed,
            isRunning: gameTimer.isRunning
        },
        playingPlayers,
        benchPlayers,
        teamGoals: parseInt(document.getElementById('teamScore').textContent || '0'),
        opponentGoals: parseInt(document.getElementById('opponentScore').textContent || '0'),
        lastSave: new Date().toISOString()
    };
    
    localStorage.setItem(`game_${GAME_ID}_data`, JSON.stringify(dataToSave));
    
    const indicator = document.getElementById('saveIndicator');
    indicator.style.opacity = '1';
    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 2000);
}

function loadSavedData() {
    const savedData = localStorage.getItem(`game_${GAME_ID}_data`);
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            
            if (data.evaluationData) {
                evaluationData = data.evaluationData;
            }
            if (data.playerTimes) {
                playerTimes = data.playerTimes;
            }
            if (data.substitutionData) {
                substitutionData = data.substitutionData;
            }
            if (data.gameTimer) {
                gameTimer.elapsed = data.gameTimer.elapsed;
                gameTimer.isRunning = data.gameTimer.isRunning;
            }
            if (data.teamGoals !== undefined && data.opponentGoals !== undefined) {
                updateScoreDisplay(data.teamGoals, data.opponentGoals);
            }
            
            renderPlayingPlayers();
            console.log('📁 Dados locais carregados');
        } catch (error) {
            console.error('Erro ao carregar dados salvos:', error);
        }
    }
}

// ============= FINALIZAÇÃO =============
function finishAndSaveGame() {
    if (!confirm('🏁 Finalizar e salvar o jogo no banco de dados?\n\nTodas as avaliações serão permanentemente registradas.')) {
        return;
    }
    
    if (gameTimer.isRunning) {
        pauseGameTimer();
    }
    
    const btn = document.querySelector('[onclick="finishAndSaveGame()"]');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    btn.disabled = true;
    
    const gameData = {
        game_id: GAME_ID,
        duration: Math.floor(gameTimer.elapsed / 1000),
        status: 'finished',
        evaluation_data: evaluationData,
        player_times: playerTimes,
        substitutions: substitutionData,
        playing_players: playingPlayers.map(p => p.id),
        bench_players: benchPlayers.map(p => p.id),
        team_goals: parseInt(document.getElementById('teamScore').textContent || '0'),
        opponent_goals: parseInt(document.getElementById('opponentScore').textContent || '0')
    };
    
    fetch('{% url 'core:api_save_complete_game' %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(gameData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            localStorage.removeItem(`game_${GAME_ID}_data`);
            
            alert('✅ Jogo salvo com sucesso!\n\n' + 
                  `Total de avaliações: ${data.total_evaluations}\n` +
                  `Substituições: ${data.total_substitutions}\n` +
                  `Placar final: ${gameData.team_goals} x ${gameData.opponent_goals}`);
            
            window.location.href = `{% url 'core:game_detail' game.id %}`;
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('Erro ao salvar:', error);
        alert('❌ Erro ao salvar o jogo:\n' + error.message + '\n\nOs dados continuam salvos localmente.');
        
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    });
}

function exportGameData() {
    const dataToExport = {
        resumo_jogo: {
            titulo: GAME_TITLE,
            data: new Date().toLocaleString('pt-BR'),
            tempo_total: document.getElementById('gameTimer').textContent,
            placar: `${document.getElementById('teamScore').textContent} x ${document.getElementById('opponentScore').textContent}`,
            total_avaliacoes: Object.values(evaluationData).reduce((total, player) => {
                return total + (player.timeline ? player.timeline.length : 0);
            }, 0)
        },
        evaluation_data: evaluationData,
        player_times: playerTimes,
        substitutions: substitutionData,
        playing_players: playingPlayers,
        bench_players: benchPlayers
    };

    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${GAME_TITLE.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// ============= UTILITÁRIOS =============
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

console.log('✅ Sistema de avaliação com design melhorado carregado!');
</script>
{% endblock %}